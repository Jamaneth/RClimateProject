---
title: "Climate Science and shit"
output: html_notebook
---

Example: model for finished product
https://www.showmeshiny.com/wpp-2015-explorer/


First and foremost: let us import all necessary libraries.
```{r}
library(tidyverse)
library(ggplot2)
library(ggthemes)
```

# Idée : étudier l'évolution des températures dans le monde

Table de données : "Climate Change: Earth Surface Temperature Data" (tiré de Berkeley Earth)
Lien : https://www.kaggle.com/berkeleyearth/climate-change-earth-surface-temperature-data

## Première idée : faire une carte du monde avec les températures moyennes par pays

* Curseur qui glisse par mois et par année ?
* Curseur qui glisse uniquement par année, avec la température moyenne ?
* Curseur qui glisse par année, avec la différence entre la température moyenne sur l'année et la température moyenne globale (moyenne qui se fait entre 1950 et 1900, ou bien moyenne totale) ?

## Deuxième idée : mettre en place des courbes pour observer l'évolution des températures moyennes par pays en fonction du temps

### Dans un premier temps, étude globale, à l'échelle du globe

#### Premier test : séparer les dates en année, mois, jour, puis supprimer les jours, et enfin sélectionner à partir de 1800 (pour avoir des données plus sûres)
```{r}
globalTemperatures <- read.csv("globalTemperatures.csv")
globalTemperatures$dt <- as.character(globalTemperatures$dt)
globalTemperatures <- globalTemperatures %>%
  separate("dt", c("year", "month", "day"), sep = "-", remove = TRUE) %>%
  select(-day)

globalTemperatures$year <- as.numeric(globalTemperatures$year)

globalTemperatures <- globalTemperatures %>%
  filter(year >= 1750)

```


#### Deuxième étape : on va faire la moyenne par an
```{r}
globalTemperaturesYear <- globalTemperatures %>%
  group_by(year) %>%
  summarise(LandAverageTemperature = mean(LandAverageTemperature))

```

#### Troisième étape : on ajoute une colonne avec la moyenne étalée sur dix ans
```{r}
globalTemperaturesYear$TenYearMovingAverage <- NA

for (i in c(10:length(globalTemperaturesYear$TenYearMovingAverage))) {
  globalTemperaturesYear$TenYearMovingAverage[i] <-
    mean(globalTemperaturesYear$LandAverageTemperature[(i-9):i])
}

```


#### Quatrième étape : on trace un graphe !
```{r}
ggplot(data = globalTemperaturesYear,
       aes(x = year, y = TenYearMovingAverage)) +
  geom_line(colour = "red", size = 1.5) +
  geom_point(aes(x = year, y = LandAverageTemperature),
             colour = "dark grey",
             size = 0.2) +
  labs(x = "Year", y = "Temperature", title = "Climate") +
  geom_ribbon(aes(x = year, ymin = LandAverageTemperature, ymax = TenYearMovingAverage), fill = "grey") +
  theme_economist()
  
```

#### Petite conclusion
De façon assez indéniable, on constate une augmentation à partir de 1950 ...


#### Faisons quelques petits tests supplémentaires
```{r}
globalTemperaturesBefore1900 <- globalTemperaturesYear %>%
  filter(year <= 1900)
averageTemp <- mean(globalTemperaturesBefore1900$LandAverageTemperature[!is.na(globalTemperaturesBefore1900$LandAverageTemperature)])

ggplot(data = globalTemperaturesYear,
       aes(x = year, y = TenYearMovingAverage - averageTemp)) +
  geom_line(colour = "dark grey", size = 1.5) +
  labs(x = "Year", y = "Temperature", title = "Temperature variation with relation to the average (until 1900)") +
  geom_ribbon(data = globalTemperaturesYear,
    aes(x = year, ymax = TenYearMovingAverage - averageTemp, ymin = 0), fill = "red") +

  theme_economist()


# Idéalement, il faudrait que la zone en haut soit en rouge, et celle en bas en bleu ...
```


### Petit truc par pays, désormais

* Dans un premier temps, on pourrait avoir un graphique global
* Ensuite, on pourrait avoir une carte avec tous les pays du monde (ou bien tous les continents, mais ça impliquerait de modifier un peu la table), et cliquer sur un pays pourrait faire apparaître le graphique correspondant

#### On remet les dates en forme
```{r}
tempsByCountry <- read.csv("GlobalLandTemperaturesByCountry.csv")

tempsByCountry$dt <- as.character(tempsByCountry$dt)
tempsByCountry <- tempsByCountry %>%
  separate("dt", c("year", "month", "day"), sep = "-", remove = TRUE) %>%
  select(-day)

tempsByCountry$year <- as.numeric(tempsByCountry$year)

```

#### On fait la moyenne par an
```{r}
tempsByCountry <- tempsByCountry %>%
  group_by(year, Country) %>%
  summarise(AverageTemperature = mean(AverageTemperature)) %>%
  arrange(Country)

```

#### On filtre un seul pays dans la liste
```{r}
selectedCountry = "Spain"
tempsSelectCountry = tempsByCountry %>% filter(Country == selectedCountry)
```


#### On ajoute la colonne avec la moyenne étalée sur dix ans
```{r}
tempsSelectCountry$TenYearAvg = NA

for (i in c(10:length(tempsSelectCountry$TenYearAvg))) {
  tempsSelectCountry$TenYearAvg[i] <- mean(tempsSelectCountry$AverageTemperature[(i-9):i])
}

View(tempsSelectCountry)
```

##### En fait, on a besoin de faire ça pour toute la base de données, peut-être
```{r}
tempsByCountry$TenYearAvg = NA

for (i in c(10:length(tempsByCountry$TenYearAvg))) {
  if(tempsByCountry$Country[i] == tempsByCountry$Country[i-9]) {
    tempsByCountry$TenYearAvg[i] <- mean(tempsByCountry$AverageTemperature[(i-9):i])
  }
}

View(tempsByCountry)
```

#### Quatrième étape : on trace un graphe !
```{r}

ggplot(data = tempsSelectCountry,
       aes(x = year, y = TenYearAvg)) +
  geom_line(colour = "red", size = 1.5) +
  geom_point(aes(x = year, y = AverageTemperature),
             colour = "dark grey",
             size = 0.2) +
  labs(x = "Year", y = "Temperature", title = paste("Climate in", selectedCountry)) +
  geom_ribbon(aes(x = year, ymin = AverageTemperature, ymax = TenYearAvg), fill = "grey") +
  theme_economist()
  
```




## Troisième idée : trouver quelques corrélations
* Lien entre les températures dans un certain pays et les famines ? (source données : https://ourworldindata.org/famines/)
* Lien entre températures et prix de la nourriture ? (source données à trouver)
* Lien entre températures et mortalité ?
* Lien entre (température - température moyenne) et croissance du PIB ?
Juste quelques pistes ...

## Quatrième idée : étudier la chaleur comme prédicteur
```{r}
(tempsByCountry %>% filter(year == 1900))[, 4][[1]]
```

```{r}
max(tempsByCountry[,4], na.rm = TRUE) + 1
```

```{r}
library(googleVis)
x <- tempsByCountry %>% filter(year == 1900)
GeoStates <- gvisGeoChart(x, locationvar = "Country",
             colorvar = "TenYearAvg",
             options = list(colorAxis ="{colors:['blue', 'red']}"))
plot(GeoStates)
```


```{r}
"a" %in% c("a", "b", "c")
```

```{r}
set.seed(993)
x <- 1:300
y <- sin(x/20) + rnorm(300,sd=.1)
y[251:255] <- NA
# Plot the unsmoothed data (gray)
plot(x, y, type="l", col=grey(.5))
# Draw gridlines
grid()

# Smoothed with lag:
# average of current sample and 19 previous samples (red)
f20 <- rep(1/20, 20)
#>  [1] 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05
#> [18] 0.05 0.05 0.05
y_lag <- stats::filter(y, f20, sides=1)
lines(x, y_lag, col="red")

# Smoothed symmetrically:
# average of current sample, 10 future samples, and 10 past samples (blue)
f21 <- rep(1/21,21)
f21
#>  [1] 0.04761905 0.04761905 0.04761905 0.04761905 0.04761905 0.04761905 0.04761905
#>  [8] 0.04761905 0.04761905 0.04761905 0.04761905 0.04761905 0.04761905 0.04761905
#> [15] 0.04761905 0.04761905 0.04761905 0.04761905 0.04761905 0.04761905 0.04761905
y_sym <- stats::filter(y, f21, sides=2)
lines(x, y_sym, col="blue")
```

